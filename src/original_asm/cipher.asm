; WARNING: FOR MACOS ONLY
; nasm -f macho64 cipher.asm -o cipher.o && ld -o cipher.macho -macosx_version_min 10.7 -e start cipher.o && ./cipher.macho

BITS 64

section .text
global start

start:
  push   rbp
  mov    rbp,rsp

  ; PRINT OUTPUT
  push   0xa203a
  mov    DWORD [rsp+0x4],0x0
  push   0x76207965
  mov    DWORD [rsp+0x4],0x65756c61
  push   0x7475706e
  mov    DWORD [rsp+0x4],0x6b206120
  push   0x61656c50
  mov    DWORD [rsp+0x4],0x69206573
  mov    rax, 0x2000004
  mov    rdi, 0x1
  mov    rsi, rsp
  mov    edx, 0x1b
  syscall
  pop    rax
  pop    rax
  pop    rax
  pop    rax
  ; GET INPUT
  mov    rax, 0x2000003
  mov    rdi, 0
  lea    rsi, [rel key]
  mov    edx, 0x10
  syscall

; GENERATE KEY
  mov    r9, 0                ; int i = 0;
  mov    r10, 0               ; int j = 0;
  lea    r13, [rel encrypted]
  lea    r14, [rel key]
  lea    r15, [rel keyframe]
loop1:
  cmp    r9, 1649               ; Length of encrypted
  jge    decrypt
  cmp    r10, 4               ; if(j == keyLen)
  jne    not_length
  xor    r10, r10             ; j = 0
  not_length:
  movzx  ecx, BYTE [r14+r10]  ; c = key[j]
  mov    BYTE [r15 + r9], cl  ; newKey[i] = c
  inc    r9                   ; i++
  inc    r10                  ; j++
  jmp    loop1

decrypt:
  xor    r9, r9               ; int i = 0;
loop2:
  cmp    r9, 1649               ; Length of encrypted
  jge    exit_loop
  movzx  ecx, BYTE [r13+r9]   ; a = encrypted[i]
  movzx  edx, BYTE [r15+r9]   ; b = keyframe[i]
  sub    ecx, edx               ; a - b
  add    ecx, 256             ; a + 256
  mov    rdx, 0
  mov    eax, ecx
  cdq
  mov    esi, 256
  idiv   esi
  mov    BYTE [r13 + r9], dl  ; decryptedMsg[i] = a
  inc    r9                   ; i++
  jmp    loop2

exit_loop:
  mov    eax, 0x2000004 ; write
  mov    rdi, 1         ; std out
  lea    rsi, [rel encrypted]
  mov    edx, 12
  syscall
  xor    eax, eax
  mov    rax, 0x2000001 ; exit
  mov    rdi, 0
  syscall

section .data
  encrypted: db 199,120,185,89,218,106,80,126,114,247,116,152,118,48,48,116,114,152,149,237,146,166,247,184,150,52,145,224,231,149,152,226,226,165,164,59,182,84,52,148,211,80,155,220,194,156,149,213,57,116,84,120,229,149,80,221,42,52,48,116,116,239,49,116,114,48,120,253,88,234,75,116,114,48,63,121,202,136,136,204,42,51,48,116,116,239,48,116,114,48,120,1,167,62,53,116,114,234,64,116,114,48,63,121,129,231,69,116,119,48,48,245,108,124,122,215,212,63,181,246,114,48,48,192,255,109,211,116,114,48,124,1,167,22,52,116,114,113,236,116,114,48,48,189,243,44,122,120,114,48,173,175,42,56,48,116,114,124,185,85,187,185,250,181,129,230,68,131,179,185,243,184,251,0,113,253,67,201,116,253,80,39,46,188,213,250,113,131,40,68,62,184,251,255,97,75,179,184,40,192,251,17,117,252,118,63,121,115,54,27,236,181,253,71,177,110,199,120,185,89,231,79,232,120,114,48,50,51,115,48,48,116,186,189,101,4,118,48,48,46,131,48,48,116,129,53,97,52,179,47,7,95,152,232,52,116,114,50,239,117,114,48,48,188,255,101,173,120,114,48,234,90,114,48,48,131,119,97,240,44,115,48,48,118,49,48,48,116,114,63,53,209,53,73,50,94,249,77,165,229,178,124,189,155,184,161,127,197,188,124,82,122,141,133,105,10,128,152,126,118,128,48,90,173,150,108,111,139,23,97,155,201,220,93,154,124,124,85,83,168,157,187,62,187,216,54,90,229,149,36,126,215,212,167,32,196,188,124,122,159,93,195,37,190,188,124,122,224,217,93,71,125,132,36,121,215,212,167,32,197,188,124,122,159,97,112,236,196,188,124,32,231,212,165,127,210,193,52,241,234,249,164,127,197,116,189,208,183,85,191,104,121,229,170,111,133,156,40,114,247,189,124,122,159,74,173,127,197,188,124,122,215,212,105,242,200,13,125,122,215,252,62,127,197,188,52,247,226,89,164,127,197,116,38,170,215,212,165,127,197,188,124,54,98,217,49,126,197,188,48,247,226,65,164,127,197,20,196,122,215,212,253,123,197,188,126,37,214,212,165,127,141,57,169,77,214,212,165,55,70,254,116,32,191,212,165,127,210,193,52,241,218,153,164,127,197,116,173,193,159,197,236,55,212,10,52,171,16,177,230,39,201,188,124,120,80,213,165,127,197,116,241,175,121,210,165,127,95,30,124,122,215,223,160,174,5,100,125,122,215,210,250,127,197,188,124,117,218,169,109,246,40,116,173,186,150,75,133,127,197,188,53,35,223,220,173,119,205,180,116,114,158,74,165,126,199,187,120,127,217,215,105,166,253,176,112,55,94,232,229,50,196,242,52,229,23,251,202,55,212,252,49,171,30,161,116,205,144,183,42,134,215,161,164,198,171,117,115,84,20,158,170,41,193,205,49,123,46,161,116,196,136,52,183,55,88,27,106,112,91,200,116,63,95,240,165,89,140,183,98,185,152,92,153,119,140,39,190,55,198,43,105,166,247,121,115,62,36,156,186,191,73,252,105,38,178,19,80,55,76,33,52,171,23,161,116,205,171,117,115,84,21,118,108,112,179,242,52,163,21,136,48,89,140,183,98,184,158,15,231,50,212,3,57,242,36,118,108,112,179,251,51,117,73,232,156,89,140,183,98,177,121,157,170,81,247,121,125,192,162,197,222,58,77,11,90,51,224,126,238,48,210,110,136,131,121,157,170,81,255,158,53,117,145,19,98,247,185,197,90,51,224,142,238,89,140,183,98,200,152,92,145,134,171,117,115,100,44,161,164,197,144,237,199,63,95,35,106,112,91,208,133,54,224,70,153,126,144,237,198,63,95,232,165,55,34,252,215,252,178,19,103,249,247,103,25,131,79,70,248,15,44,148,204,83,200,189,189,141,25,33,204,225,4,142,55,94,156,197,209,62,229,162,176,230,111,208,170,119,240,66,87,84,23,146,198,7,3,208,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,165,127,197,188,124,122,215,212,133,159,229,220,156,60,150,157,105,159,122,116,61,54,154,181,175,117,122,220,156,154,183,180,82,159,229,220,156,154,183,167,133,159,229,220,156,154,183,180,175,72,229,220,156,154,183,180,133,159,122,220,156,77,183,180,133,159,229,143,156,154,183,180,175,159,229,220,156,154,183,180,133,159,229,220,156,154,183,183,139,159,229,143,156,154,183,180,133,159,207,220,156,148,194,178,135,146,243,135,156,154,183,180,133,67,229,136,146,151,194,144,133,159,207,220,147,154,183,180,133,159,229,220,158,151,193,190,90,64,236,220,146,151,184,180,133,159,207,168,156,154,183,180,133,64,229,220,156,154,183,180,133,159,229,215,156,154,183,180,133,159,207,136,155,151,193,175,90,147,229,220,156,148,176,175,139,147,234,220,156,154,183,180,133,159,207,220,92,157,194,193,136,146,234,214,67,70,194,193,130,159,229,220,156,154,183,218,83,73,123,142,74,76,169,166,83,73,123,142,74,76,169,166,83,73,123,142,74,112,116,114,48,48,116,114,48,48,116,114,48,48,116,114,48,48,191,215,149,160,148,217,159,153,226,217,81,58,148,146,80,80,148,184,113,121,192,146,135,120,181,190,117,81,126,124,135,80,148,146,80,80,203,146,80,80,148,146,80,135,148,146,80,80,148,146,80,80,126,201,80,80,148,146,80,80,148,146,135,80,148,201,80,80,148,146,80,135,148,146,80,80,126,146,80,80,148,146,80,80,148,146,80,80,148,146,80,87,162,146,80,135,148,146,80,80,148,146,58,80,148,160,93,82,150,159,94,143,148,146,80,80,148,206,80,140,162,159,93,172,148,146,58,80,163,146,80,80,148,146,80,80,150,159,94,94,211,209,89,80,162,159,87,80,148,146,58,172,148,146,80,80,148,209,80,80,148,146,80,80,148,146,80,95,148,146,80,80,148,146,58,140,155,159,94,143,211,158,80,80,148,160,143,143,162,158,87,80,148,146,80,80,148,146,58,80,212,153,93,93,161,159,87,94,211,206,93,93,155,146,80,80,148,146,80,58,202,200,134,134,202,200,134,134,202,200,134,134,202,200,134,134,202,200,134,134,202,124
  key: times 0x10 db 0
  keyframe: times 1649 db 0
  msg: db "Keep going!", 10
  msg2:
  db 32,32,32,32,32,70,65,73,76,32,87,72,65,76,69,33,10,10,87,32,32,32,32,32,87,32,32,32,32,32,32,87,32,32,32,32,32,32,32,32,10,87,32,32,32,32,32,32,32,32,87,32,32,87,32,32,32,32,32,87,32,32,32,32,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,39,46,32,32,87,32,32,32,32,32,32,10,32,32,46,45,34,34,45,46,95,32,32,32,32,32,92,32,92,46,45,45,124,32,32,10,32,47,32,32,32,32,32,32,32,34,45,46,46,95,95,41,32,46,45,39,32,32,32,10,124,32,32,32,32,32,95,32,32,32,32,32,32,32,32,32,47,32,32,32,32,32,32,10,92,39,45,46,95,95,44,32,32,32,46,95,95,46,44,39,32,32,32,32,32,32,32,10,32,96,39,45,45,45,45,39,46,95,92,45,45,39,32,32,32,32,32,32,10,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86, 10
