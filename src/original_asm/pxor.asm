; WARNING: FOR MACOS ONLY
; nasm -f macho64 pxor.asm -o pxor.o && ld -o pxor.macho -macosx_version_min 10.7 -e start pxor.o && ./pxor.macho

BITS 64

section .text
global start

start:
  push   rbp
  mov    rbp, rsp

  ; PRINT OUTPUT
  push   0xa203a
  mov    DWORD [rsp+0x4],0x0
  push   0x76207965
  mov    DWORD [rsp+0x4],0x65756c61
  push   0x7475706e
  mov    DWORD [rsp+0x4],0x6b206120
  push   0x61656c50
  mov    DWORD [rsp+0x4],0x69206573
  mov    rax, 0x2000004
  mov    rdi, 0x1
  mov    rsi, rsp
  mov    edx, 0x1b
  syscall
  pop    rax
  pop    rax
  pop    rax
  pop    rax
  ; GET INPUT
  mov    rax, 0x2000003
  mov    rdi, 0
  lea    rsi, [rel key]
  mov    edx, 0x10
  syscall

  ; CHECK 4 BYTES OF KEY
  movzx  edx, WORD [rel key]
  cmp    edx, 0x62634A4C
  jne    fail

  lea    r15, [rel encrypted]
  lea    r14, [rel key]
  mov    r12, 0 ; i
loop1:
  cmp    r12, 0x21C
  jge    exitloop
  mov    eax, 8
  mov    rcx, r12  ;j = i
  mov    r10, rcx  ; store i
  movzx  edx, BYTE [r15+rcx] ; encrypted[i]
  mov    r11d, eax ; store 8
  mov    eax, r10d ; i
  mov    r9d, edx ; encrypted[i]
  cdq
  mov    esi, r11d ; 8
  idiv   esi
  movsxd rcx, edx
  movzx  edx, BYTE [r14+rcx] ; key[i % 8]
  mov    edi, r9d ; encrypted[i]
  xor    edi, edx
  mov    r8b, dil ; product
  mov    rcx, r12
  mov    [r15+rcx], r8b ; encrypted[i] = product
  inc    r12 ; i++
  jmp    loop1
exitloop:
  mov    edx, DWORD [r15]
  cmp    edx, 0xE5894855
  jne    fail
  mov    eax, 0x2000004 ; write
  mov    rdi, 1         ; std out
  lea    rsi, [rel msg]
  mov    edx, 12
  syscall
  xor    eax, eax
  call   r15
  jmp    final
fail:
  mov    eax, 0x2000004 ; write
  mov    rdi, 1         ; std out
  lea    rsi, [rel msg2]
  mov    edx, 230
  syscall
  xor    eax, eax
  mov    rax, 0x2000001 ; exit
  mov    rdi, 0
  syscall
final:
  pop    rbp
  retn

section .data
  encrypted:
    db 0x19
    db 0x02
    db 0xEA
    db 0x87
    db 0x1D
    db 0x75
    db 0x71
    db 0x40
    db 0x4C
    db 0x8D
    db 0x27
    db 0x46
    db 0x71
    db 0x4F
    db 0x51
    db 0x4A
    db 0x4C
    db 0x22
    db 0x06
    db 0x1B
    db 0x55
    db 0x39
    db 0x96
    db 0x0E
    db 0x68
    db 0x4E
    db 0x02
    db 0x0E
    db 0x00
    db 0x2A
    db 0x39
    db 0x24
    db 0x3C
    db 0x3F
    db 0x17
    db 0xA5
    db 0x31
    db 0x6B
    db 0x55
    db 0x6A
    db 0x2D
    db 0x6A
    db 0x08
    db 0x0A
    db 0x25
    db 0x23
    db 0x34
    db 0x2B
    db 0x8B
    db 0x0E
    db 0x47
    db 0x66
    db 0x06
    db 0x2A
    db 0x71
    db 0x23
    db 0xF4
    db 0x4E
    db 0x63
    db 0x62
    db 0x77
    db 0xF0
    db 0x50
    db 0x4A
    db 0x4C
    db 0x4A
    db 0x2B
    db 0xEB
    db 0x93
    db 0xF5
    db 0x4A
    db 0x4A
    db 0x4C
    db 0x4A
    db 0x6C
    db 0x67
    db 0x2D
    db 0x17
    db 0x09
    db 0x12
    db 0xF4
    db 0x49
    db 0x63
    db 0x62
    db 0x77
    db 0xF0
    db 0x51
    db 0x4A
    db 0x4C
    db 0x4A
    db 0x2B
    db 0xEF
    db 0x40
    db 0xF5
    db 0x50
    db 0x4A
    db 0x4C
    db 0xF0
    db 0x73
    db 0x62
    db 0x75
    db 0x4F
    db 0x5E
    db 0x4F
    db 0x04
    db 0xC7
    db 0x6E
    db 0xCE
    db 0x74
    db 0x4F
    db 0x51
    db 0x02
    db 0xF6
    db 0x42
    db 0x63
    db 0x62
    db 0x75
    db 0x4F
    db 0x51
    db 0x4A
    db 0x4C
    db 0x06
    db 0xEE
    db 0x67
    db 0xDE
    db 0x4E
    db 0x51
    db 0x4A
    db 0xA4
    db 0x1F
    db 0x63
    db 0x62
    db 0x75
    db 0x07
    db 0xDC
    db 0x47
    db 0x13
    db 0x4B
    db 0x63
    db 0x62
    db 0x3D
    db 0xF5
    db 0x61
    db 0x4A
    db 0x4C
    db 0x4A
    db 0x63
    db 0x62
    db 0x75
    db 0x4F
    db 0x1D
    db 0xC7
    db 0x49
    db 0x04
    db 0x62
    db 0x62
    db 0x75
    db 0x03
    db 0xDC
    db 0x47
    db 0xCB
    db 0x4B
    db 0x63
    db 0x62
    db 0x9D
    db 0xFD
    db 0x51
    db 0x4A
    db 0x4C
    db 0xF2
    db 0x67
    db 0x62
    db 0x75
    db 0x4D
    db 0xEE
    db 0x4B
    db 0x4C
    db 0x4A
    db 0x63
    db 0x2A
    db 0xF8
    db 0x7A
    db 0x60
    db 0x4B
    db 0x4C
    db 0x4A
    db 0x2B
    db 0xE1
    db 0xB3
    db 0x47
    db 0xEB
    db 0x62
    db 0x4C
    db 0x4A
    db 0x63
    db 0x6D
    db 0x70
    db 0x07
    db 0xDA
    db 0x4F
    db 0x53
    db 0x4B
    db 0x63
    db 0x62
    db 0x3D
    db 0x7E
    db 0x8A
    db 0x02
    db 0x7D
    db 0x83
    db 0x2B
    db 0x53
    db 0xA7
    db 0x07
    db 0x60
    db 0xB5
    db 0x11
    db 0x89
    db 0x36
    db 0x2A
    db 0xFC
    db 0xAA
    db 0x19
    db 0x7B
    db 0x8C
    db 0x0B
    db 0xD8
    db 0x42
    db 0x75
    db 0x4F
    db 0x51
    db 0x03
    db 0xF5
    db 0x42
    db 0x6B
    db 0x6A
    db 0x7D
    db 0x47
    db 0x59
    db 0x42
    db 0x44
    db 0x03
    db 0xD9
    db 0x62
    db 0x74
    db 0x4D
    db 0x52
    db 0x4E
    db 0x49
    db 0x4C
    db 0x64
    db 0x2E
    db 0x4C
    db 0x97
    db 0x25
    db 0x46
    db 0x01
    db 0xC3
    db 0x77
    db 0xA2
    db 0x38
    db 0x4E
    db 0x9B
    db 0x02
    db 0xB3
    db 0x8A
    db 0x88
    db 0x8D
    db 0x3D
    db 0x7E
    db 0x91
    db 0x07
    db 0x7D
    db 0x83
    db 0x2E
    db 0x53
    db 0xA7
    db 0x02
    db 0x5E
    db 0xFC
    db 0x50
    db 0x4A
    db 0x2E
    db 0x63
    db 0xAC
    db 0x29
    db 0x18
    db 0x45
    db 0x22
    db 0x89
    db 0x2D
    db 0x6D
    db 0xC3
    db 0x53
    db 0x40
    db 0x07
    db 0x4D
    db 0x93
    db 0x2E
    db 0x53
    db 0xAE
    db 0x0A
    db 0xD9
    db 0x81
    db 0x01
    db 0xCD
    db 0xA8
    db 0x2D
    db 0x7A
    db 0xF9
    db 0x4D
    db 0x42
    db 0x09
    db 0xC2
    db 0x7F
    db 0x62
    db 0x13
    db 0x06
    db 0x5E
    db 0x34
    db 0x8F
    db 0x0D
    db 0xEB
    db 0x7E
    db 0x7D
    db 0x06
    db 0xAE
    db 0x88
    db 0x01
    db 0x7B
    db 0xB8
    db 0x2E
    db 0x4C
    db 0x9D
    db 0x1C
    db 0x45
    db 0x08
    db 0x99
    db 0x2B
    db 0x9D
    db 0xB5
    db 0xCB
    db 0x91
    db 0x3F
    db 0xF0
    db 0x17
    db 0xA0
    db 0x37
    db 0x3D
    db 0xC6
    db 0xB4
    db 0x02
    db 0x7D
    db 0x8A
    db 0x2E
    db 0x53
    db 0xA7
    db 0x29
    db 0x18
    db 0x45
    db 0x22
    db 0x88
    db 0x05
    db 0x2B
    db 0x7A
    db 0x21
    db 0x9B
    db 0x02
    db 0x75
    db 0x88
    db 0x17
    db 0x17
    db 0x13
    db 0x06
    db 0x5E
    db 0x34
    db 0x8E
    db 0x03
    db 0x9C
    db 0xA0
    db 0x38
    db 0x7E
    db 0x8A
    db 0x0F
    db 0xC4
    db 0x99
    db 0x05
    db 0x2B
    db 0x7A
    db 0x21
    db 0x92
    db 0x05
    db 0x43
    db 0xFC
    db 0x77
    db 0x7B
    db 0x13
    db 0x06
    db 0x5E
    db 0x34
    db 0x87
    db 0x2C
    db 0x2A
    db 0x6D
    db 0x1B
    db 0x9D
    db 0x1C
    db 0x4B
    db 0x96
    db 0x07
    db 0x52
    db 0xB9
    db 0x30
    db 0xC7
    db 0x82
    db 0x2C
    db 0x05
    db 0x45
    db 0x0D
    db 0xA9
    db 0x3A
    db 0x40
    db 0xE7
    db 0x5E
    db 0x55
    db 0x2C
    db 0x2A
    db 0x6D
    db 0x1B
    db 0x95
    db 0x37
    db 0x03
    db 0x43
    db 0x34
    db 0xA0
    db 0x25
    db 0xFD
    db 0x5B
    db 0x48
    db 0x2C
    db 0x05
    db 0x45
    db 0x1D
    db 0xA9
    db 0x13
    db 0x06
    db 0x5E
    db 0x34
    db 0x9E
    db 0x0D
    db 0xEB
    db 0x76
    db 0x6C
    db 0x29
    db 0x18
    db 0x45
    db 0x32
    db 0x91
    db 0x2E
    db 0x63
    db 0xAF
    db 0x02
    db 0x60
    db 0x91
    db 0x09
    db 0xC2
    db 0xB0
    db 0x2D
    db 0x7A
    db 0xF9
    db 0x45
    db 0x53
    db 0x00
    db 0x45
    db 0xD5
    db 0x7E
    db 0x74
    db 0x02
    db 0x60
    db 0x90
    db 0x09
    db 0xC2
    db 0x77
    db 0x62
    db 0x3D
    db 0xB0
    db 0x91
    db 0xA1
    db 0xCA
    db 0x17
    db 0xA0
    db 0x20
    db 0xF3
    db 0x9D
    db 0xEE
    db 0xEF
    db 0x55
    db 0xF2
    db 0xD5
    db 0xDF
    db 0xE5
    db 0xA6
    db 0x39
    db 0x9A
    db 0x25
    db 0x7D
    db 0x4A
    db 0x9A
    db 0x67
    db 0xBB
    db 0xB4
    db 0x9A
    db 0xB7
    db 0xB9
    db 0x1D
    db 0x10
    db 0x14
    db 0x36
    db 0x48
    db 0xA7
    db 0x08
    db 0x58
    db 0x31
    db 0x97
    db 0x8C
    db 0xE5
    db 0x45
    db 0x7C
    db 0x41
    db 0x55
    db 0xD1
    db 0x30
    db 0x1E
    db 0xBD
    db 0x3B
    db 0x90
    db 0xD1
    db 0xA6
    db 0x5F
    db 0x62
  key: times 0x10 db 0
  msg: db "Keep going!", 10
  msg2:
    db 32,32,32,32,32,70,65,73,76,32,87,72,65,76,69,33,10,10,87,32,32,32,32,32,87,32,32,32,32,32,32,87,32,32,32,32,32,32,32,32,10,87,32,32,32,32,32,32,32,32,87,32,32,87,32,32,32,32,32,87,32,32,32,32,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,39,46,32,32,87,32,32,32,32,32,32,10,32,32,46,45,34,34,45,46,95,32,32,32,32,32,92,32,92,46,45,45,124,32,32,10,32,47,32,32,32,32,32,32,32,34,45,46,46,95,95,41,32,46,45,39,32,32,32,10,124,32,32,32,32,32,95,32,32,32,32,32,32,32,32,32,47,32,32,32,32,32,32,10,92,39,45,46,95,95,44,32,32,32,46,95,95,46,44,39,32,32,32,32,32,32,32,10,32,96,39,45,45,45,45,39,46,95,92,45,45,39,32,32,32,32,32,32,10,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86, 10
